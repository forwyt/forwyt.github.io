<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="jasonPHD">
  <!-- Open Graph Data -->
  <meta property="og:title" content="cocopod原理分析"/>
  <meta property="og:description" content="Apple/易娱科技" />
  <meta property="og:site_name" content="Developer JasonPhd"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.com"/>
  
    <link rel="alternate" href="/atom.xml" title="Developer JasonPhd" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Developer JasonPhd</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">cocopod原理分析</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/forwyt">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:465379032@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By jasonPHD</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2018-03-19</span>
            <span class="time">11:40:05</span>
          </span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h1 id="CocoaPods工作原理-以及如何制作framework"><a href="#CocoaPods工作原理-以及如何制作framework" class="headerlink" title="CocoaPods工作原理,以及如何制作framework"></a>CocoaPods工作原理,以及如何制作framework</h1><p><img src="/2018/03/19/cocopod原理分析/logo.png" alt="logo"></p>
<h1 id="cocoapods"><a href="#cocoapods" class="headerlink" title="cocoapods"></a><strong>cocoapods</strong></h1><p> 在iOS开发中基本上每个人或多或少的都有接触使用过cocoapods,从2011年9月1日上线,cocoapod就深受开发者的喜爱,这种第三方包(库)管理工具就如同:</p>
<ul>
<li><p>Android–&gt;Gradle</p>
</li>
<li><p>Node.js–&gt;npm</p>
</li>
<li><p>python–&gt; pip</p>
</li>
</ul>
<p>这些包管理工具能够快速,高效的集成我们的第三方库. cocoapods是有Ruby来编写</p>
<h2 id="组成结构-pod-init"><a href="#组成结构-pod-init" class="headerlink" title="组成结构(pod init)"></a><strong>组成结构(pod init)</strong></h2><p>基于网上非常多如何安装cocoapod教程,这里不再描述cocoapods如何安装以及如何切换镜像源.</p>
<p> <strong>podfile</strong></p>
<p><img src="/2018/03/19/cocopod原理分析/WX20180319-103100.png" alt="WX20180319-103100"></p>
<p>podfile是cocoapods的约束描述,这种文件就是ruby的简写,其代码在实际运作中是进行翻译的<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">source <span class="string">'http://source.git'</span></div><div class="line">platform <span class="symbol">:ios</span>, <span class="string">'8.0'</span></div><div class="line"></div><div class="line">target <span class="string">'Demo'</span> <span class="keyword">do</span></div><div class="line">pod <span class="string">'AFNetworking'</span></div><div class="line">pod <span class="string">'SDWebImage'</span></div><div class="line">pod <span class="string">'Masonry'</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p><strong>第一步</strong> 定义类似以下几个方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># eval_pod.rb</span></div><div class="line">$hash_value = &#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(url)</span></span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">target</span><span class="params">(target)</span></span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">platform</span><span class="params">(platform, version)</span></span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">pod</span><span class="params">(pod)</span></span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>使用了全局变量hash_value存储podfile中那些指定的依赖库,</p>
<p><strong>第二步</strong> 读取代码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># eval_pod.rb</span></div><div class="line">content = File.read <span class="string">'./Podfile'</span></div><div class="line">eval content</div><div class="line">p $hash_value</div></pre></td></tr></table></figure>
<p><strong>第三步</strong> 读取了Podfile文件中的内容，并把它的内容当做字符串执行，最后打印hash_value的值<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ruby eval_pod.rb</div><div class="line">&#123;<span class="string">"source"</span>=&gt;<span class="string">"http://source.git"</span>, <span class="string">"targets"</span>=&gt;[<span class="string">"Demo"</span>], <span class="string">"pods"</span>=&gt;[<span class="string">"AFNetworking"</span>, <span class="string">"SDWebImage"</span>, <span class="string">"Masonry"</span>]&#125;<span class="string">`这样我们就得到了基本上的podfile解析结果</span></div></pre></td></tr></table></figure></p>
<h2 id="cocoapods实现-pod-install"><a href="#cocoapods实现-pod-install" class="headerlink" title="cocoapods实现(pod install)"></a><strong>cocoapods实现(pod install)</strong></h2><blockquote>
<p>podinstall 由command类派生出真正的父类 install</p>
</blockquote>
<p>install方法中有两个我们熟知:pod install/pod update</p>
<p>后者会无视podfile.lock文件重新对podfile文件进行类似第一部分解析</p>
<p>podfile中依赖是由cocoapod-core核心模块来完成<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">from_ruby</span><span class="params">(path, contents = <span class="literal">nil</span>)</span></span></div><div class="line">  contents <span class="params">||</span>= File.open(path, <span class="string">'r:utf-8'</span>, &amp;<span class="symbol">:read</span>)</div><div class="line"></div><div class="line">  podfile = Podfile.new(path) <span class="keyword">do</span></div><div class="line">	<span class="keyword">begin</span></div><div class="line">	  eval(contents, <span class="literal">nil</span>, path.to_s)</div><div class="line">	<span class="keyword">rescue</span> Exception =&gt; e</div><div class="line">	  message = <span class="string">"Invalid `<span class="subst">#&#123;path.basename&#125;</span>` file: <span class="subst">#&#123;e.message&#125;</span>"</span></div><div class="line">	  raise DSLError.new(message, path, e, contents)</div><div class="line">	<span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line">  podfile</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>导入DSL<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Podfile</span></span></div><div class="line">	<span class="class"><span class="keyword">module</span> <span class="title">DSL</span></span></div><div class="line">	  <span class="function"><span class="keyword">def</span> <span class="title">pod</span><span class="params">(name = <span class="literal">nil</span>, *requirements)</span></span> <span class="keyword">end</span></div><div class="line">	  <span class="function"><span class="keyword">def</span> <span class="title">target</span><span class="params">(name, options = <span class="literal">nil</span>)</span></span> <span class="keyword">end</span></div><div class="line">	  <span class="function"><span class="keyword">def</span> <span class="title">platform</span><span class="params">(name, target = <span class="literal">nil</span>)</span></span> <span class="keyword">end</span></div><div class="line">	  <span class="function"><span class="keyword">def</span> <span class="title">inhibit_all_warnings!</span> <span class="title">end</span></span></div><div class="line">	  <span class="function"><span class="keyword">def</span> <span class="title">use_frameworks!</span><span class="params">(flag = <span class="literal">true</span>)</span></span> <span class="keyword">end</span></div><div class="line">	  <span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(source)</span></span> <span class="keyword">end</span></div><div class="line">	  ...</div><div class="line">	<span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>总结一下，CocoaPods对Podfile的解析与我们在前面做的手动解析Podfile的原理差不多，构建一个包含一些方法的上下文，然后直接执行eval方法将文件的内容当做代码来执行，这样只要Podfile中的数据是符合规范的，那么解析Podfile就是非常简单容易的。</p>
</blockquote>
<p>在install方法里面会出现一个resolve_dependencies类创建Analyzer实例对象</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">resolve_dependencies</span></span></div><div class="line">  analyzer = create_analyzer</div><div class="line"></div><div class="line">  plugin_sources = run_source_provider_hooks</div><div class="line">  analyzer.sources.insert(<span class="number">0</span>, *plugin_sources)</div><div class="line"></div><div class="line">  UI.section <span class="string">'Updating local specs repositories'</span> <span class="keyword">do</span></div><div class="line">	analyzer.update_repositories</div><div class="line">  <span class="keyword">end</span> <span class="keyword">if</span> repo_update?</div><div class="line"></div><div class="line">  UI.section <span class="string">'Analyzing dependencies'</span> <span class="keyword">do</span></div><div class="line">	analyze(analyzer)</div><div class="line">	validate_build_configurations</div><div class="line">	clean_sandbox</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p><strong>解决依赖</strong><br>我们开发中知道,如果你用xcode去简历一个framework最头疼的问题无异于,需要引入第三方库,一旦这个库封装的不好,可能导致在别人使用的时候导致冲突,但是cocoapods引入库处理的非常好</p>
<blockquote>
<p>CocoaPods为了解决Podfile中声明的依赖关系，使用了一个叫做Milinillo的依赖关系解决算法;但是，笔者在Google上并没有找到与这个算法相关的其他信息，推测是CocoaPods为了解决iOS中的依赖关系创造的算法。</p>
</blockquote>
<p>Milinillo算法的核心是回溯（Backtracking）以及向前检查（forward check），整个过程会追踪栈中的两个状态（依赖和可能性）。</p>
<p><strong>下载依赖</strong><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">installer.install_source_of_pod</div><div class="line"><span class="params">|-- create_pod_installer</span></div><div class="line"><span class="params">|</span>	<span class="string">`-- PodSourceInstaller.new</span></div><div class="line"><span class="string">`</span>-- podSourceInstaller.install!</div><div class="line">	<span class="string">`-- download_source</span></div><div class="line"><span class="string">	   `</span>-- Downloader.download</div><div class="line">		   <span class="string">`-- Downloader.download_request</span></div><div class="line"><span class="string">			   `</span>-- Downloader.download_source</div><div class="line">				   <span class="params">|-- Downloader.for_target</span></div><div class="line"><span class="params">				   |</span>   <span class="params">|-- Downloader.class_for_options</span></div><div class="line"><span class="params">				   |</span>   <span class="string">`-- Git/HTTP/Mercurial/Subversion.new</span></div><div class="line"><span class="string">				   |-- Git/HTTP/Mercurial/Subversion.download</span></div><div class="line"><span class="string">				   `</span>-- Git/HTTP/Mercurial/Subversion.download!</div><div class="line">					   <span class="string">`-- Git.clone</span></div></pre></td></tr></table></figure></p>
<h2 id="生成pods-xodeproj"><a href="#生成pods-xodeproj" class="headerlink" title="生成pods.xodeproj"></a>生成pods.xodeproj</h2><p>generate!方法<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">这个方法做了几件小事：</div><div class="line"><span class="number">1</span>.生成Pods.xcodeproj工程</div><div class="line"><span class="number">2</span>.将依赖中的文件加入工程</div><div class="line"><span class="number">3</span>.将依赖中的图书馆加入工程</div><div class="line"><span class="number">4</span>.设置目标依赖（Target Dependencies）</div><div class="line">这几件事情都离不开CocoaPods的另一个组件Xcodeproj，</div><div class="line">这是一个可以操作一个Xcode工程中的组以及文件的组件，</div><div class="line">我们都知道对Xcode工程的修改大多数情况下都是</div><div class="line">对一个名叫project.pbxproj的文件进行修改，</div><div class="line">而Xcodeproj这个组件就是CocoaPods团队开发的用于操作这个文件的第三方库。</div></pre></td></tr></table></figure></p>
<h2 id="生成工作区-workspace"><a href="#生成工作区-workspace" class="headerlink" title="生成工作区 workspace"></a>生成工作区 workspace</h2><p>使用Xcodeproj修改Copy Resource Script Phrase等设置.</p>
<p>保存project.pbxproj</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>cocoapods是通过ruby来构成,首先分析podfile变成一个hash_value数组存放所有的依赖,然后通过构造对象解析器来对依赖进行细化,然后传递给下载器下载,最后通过调用xcode来生成podproj,最后调用copy resources脚本来生成一个工作区,就可以使用了😊</p>
<p><a href="https://draveness.me/cocoapods" target="_blank" rel="external">参考1</a></p>
<p><a href="https://cocoapods.org/" target="_blank" rel="external">参考2</a></p>

        </div>
      </div>
    </div>
  </div>
</article>
<!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" style = "width:70%;margin:0 auto"  data-uid="MTAyMC8zMTEwNS83NjU0">
  <script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
  </script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

